<!DOCTYPE html>
<html lang="zh-CN" oncontextmenu="return false;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>五4班作业订正系统</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(90deg, #409EFF, #64b5f6);
            color: white;
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .header h1 {
            margin: 0;
            font-size: 28px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .poem {
            text-align: center;
            font-size: 18px;
            line-height: 1.5;
            font-weight: bold;
        }
        .current-time {
            font-size: 28px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .controls {
            margin-bottom: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .control-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        .control-group label {
            font-weight: bold;
            color: #333;
        }
        .main-content {
            display: flex;
            gap: 20px;
        }
        .stats {
            width: 130px;
            background: linear-gradient(135deg, #ffffff, #f0f4f8);
            padding: 20px 15px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .stat-item {
            text-align: center;
            margin-bottom: 25px;
            padding: 10px;
            border-radius: 12px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .stat-item:last-child {
            margin-bottom: 0;
        }
        .stat-number {
            font-size: 28px;
            font-weight: bold;
        }
        .finished {
            color: #67C23A;
        }
        .unfinished {
            color: #F56C6C;
        }
        .students-section {
            flex: 1;
        }
        .students-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .student-btn {
            height: 70px;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            width: 100%;
            box-sizing: border-box;
            padding: 8px;
            text-align: center;
            margin: 0;
            border-radius: 15px;
            border: 2px solid #e0e0e0;
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .student-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.15);
        }
        .el-button.unfinished {
            background: linear-gradient(135deg, #ff7b7b, #ff5252);
            border: 2px solid #ff6b6b;
            color: white;
            width: 100%;
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            padding: 8px;
            text-align: center;
            margin: 0;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(255, 82, 82, 0.3);
            transition: all 0.3s ease;
        }
        .el-button.unfinished:hover {
            background: linear-gradient(135deg, #ff6b6b, #ff4242);
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(255, 82, 82, 0.4);
        }
        .el-button.finished {
            background: linear-gradient(135deg, #67c23a, #4eab29);
            border: 2px solid #67c23a;
            color: white;
            width: 100%;
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            padding: 8px;
            text-align: center;
            margin: 0;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(103, 194, 58, 0.3);
            transition: all 0.3s ease;
        }
        .el-button.finished:hover {
            background: linear-gradient(135deg, #7cd94d, #5cb831);
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(103, 194, 58, 0.4);
        }
        .spacer {
            width: 130px;
        }
        /* 弹窗样式优化 */
        .el-dialog {
            border-radius: 15px !important;
            overflow: hidden;
        }
        .el-dialog__header {
            background: linear-gradient(90deg, #409EFF, #64b5f6);
            color: white;
            padding: 20px;
        }
        .el-dialog__title {
            color: white;
            font-weight: bold;
        }
        .el-dialog__body {
            padding: 20px;
        }
        .el-dialog__footer {
            padding: 15px 20px;
            background-color: #f5f7fa;
        }
        /* 按钮样式优化 */
        .el-button {
            border-radius: 10px;
            font-weight: bold;
        }
        .el-button--primary {
            background: linear-gradient(90deg, #409EFF, #64b5f6);
            border: none;
        }
        .el-button--success {
            background: linear-gradient(90deg, #67C23A, #95d475);
            border: none;
        }
        .el-button--warning {
            background: linear-gradient(90deg, #E6A23C, #f3d19e);
            border: none;
        }
        .el-button--danger {
            background: linear-gradient(90deg, #F56C6C, #ff8e8e);
            border: none;
        }
        /* 表格样式优化 */
        .el-table {
            border-radius: 10px;
            overflow: hidden;
        }
        .el-table th {
            background-color: #ecf5ff;
        }
        /* 输入框样式优化 */
        .el-input__inner {
            border-radius: 10px;
        }
        .el-select .el-input__inner {
            border-radius: 10px;
        }
        .el-date-editor.el-input {
            border-radius: 10px;
        }
        /* 选择器样式优化 */
        .el-select-dropdown {
            border-radius: 10px;
        }
        .el-date-picker {
            border-radius: 15px;
        }
        /* 加载指示器样式 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 24px;
            color: #409EFF;
        }
        .loading-content {
            text-align: center;
        }
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #409EFF;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app" v-loading.fullscreen.lock="loading">
        <div class="header">
            <h1>五4班作业订正系统</h1>
            <div class="poem">
                百川东到海，何时复西归？<br>
                少壮不努力，老大徒伤悲。
            </div>
            <div class="current-time">{{ currentTime }}</div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <el-date-picker
                    v-model="currentDate"
                    type="date"
                    placeholder="选择日期"
                    format="yyyy 年 MM 月 dd 日"
                    value-format="yyyy-MM-dd"
                    @change="loadData"
                    :clearable="false">
                </el-date-picker>
                
                <el-button @click="prevDay">上一天</el-button>
                <el-button @click="nextDay">下一天</el-button>
                
                <el-select v-model="selectedType" @change="loadData" placeholder="请选择作业类型">
                    <el-option
                        v-for="type in homeworkTypes"
                        :key="type.id"
                        :label="type.name"
                        :value="type.id">
                    </el-option>
                </el-select>
                
                <el-input
                    v-model="homeworkContent"
                    placeholder="请输入作业内容"
                    style="width: 300px;"
                    @focus="showHomeworkContentDialog">
                </el-input>
                
                <el-button @click="resetStatus" type="warning">重置本页面订正状态</el-button>
                <el-button @click="showUnfinishedStudents">本作业欠交名单</el-button>
                
                <span style="margin-left: 10px; font-weight: bold;">彻查学生作业：</span>
                <el-autocomplete
                    v-model="searchKeyword"
                    :fetch-suggestions="querySearch"
                    placeholder="请输入学号或姓名"
                    @select="handleSelectStudent"
                    style="width: 150px;"
                    :trigger-on-focus="true">
                    <template slot-scope="{ item }">
                        <div class="name">{{ item.studentNumber }} - {{ item.name }}</div>
                    </template>
                </el-autocomplete>
            </div>
        </div>
        
        <div class="main-content">
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number finished">{{ finishedCount }}</div>
                    <div>已订正</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number unfinished">{{ unfinishedCount }}</div>
                    <div>未订正</div>
                </div>
            </div>
            
            <div class="students-section">
                <div class="students-grid">
                    <el-button
                        v-for="student in sortedStudents"
                        :key="student.id"
                        :class="getStudentButtonClass(student)"
                        @click="toggleStudentStatus(student)"
                        class="student-btn">
                        {{ student.studentNumber }}.{{ student.name }}
                    </el-button>
                </div>
            </div>
            
            <div class="spacer"></div>
        </div>
        
        <!-- 学生历史欠交记录对话框 -->
        <el-dialog title="学生历史欠交记录" :visible.sync="studentHistoryDialogVisible" width="60%">
            <div style="margin-bottom: 10px;">
                <el-button @click="sortStudentHistory('date', 'asc')">日期升序</el-button>
                <el-button @click="sortStudentHistory('date', 'desc')">日期降序</el-button>
                <el-button @click="sortStudentHistory('typeName', 'asc')">作业类型升序</el-button>
                <el-button @click="sortStudentHistory('typeName', 'desc')">作业类型降序</el-button>
            </div>
            <el-table :data="studentHistoryRecords" style="width: 100%">
                <el-table-column prop="date" label="日期" width="120">
                    <template slot-scope="scope">
                        {{ formatDate(scope.row.date) }}
                    </template>
                </el-table-column>
                <el-table-column prop="typeName" label="作业类型" width="120"></el-table-column>
                <el-table-column label="操作" width="120">
                    <template slot-scope="scope">
                        <el-button 
                            size="mini" 
                            :type="scope.row.corrected ? 'success' : 'danger'" 
                            @click="markAsFinished(scope.row)">
                            {{ scope.row.corrected ? '已完成' : '标记完成' }}
                        </el-button>
                    </template>
                </el-table-column>
                <el-table-column prop="content" label="内容" min-width="200" show-overflow-tooltip></el-table-column>
            </el-table>
        </el-dialog>
        
        <!-- 历史欠交学生对话框 -->
        <el-dialog title="历史欠交学生" :visible.sync="unfinishedStudentsDialogVisible" width="70%">
            <div style="margin-bottom: 10px;">
                <el-button @click="sortUnfinishedStudents('date', 'asc')">日期升序</el-button>
                <el-button @click="sortUnfinishedStudents('date', 'desc')">日期降序</el-button>
                <el-button @click="sortUnfinishedStudents('studentNumber', 'asc')">学号升序</el-button>
                <el-button @click="sortUnfinishedStudents('studentNumber', 'desc')">学号降序</el-button>
            </div>
            <el-table :data="unfinishedStudents" style="width: 100%" :max-height="400">
                <el-table-column prop="date" label="日期" width="120"></el-table-column>
                <el-table-column prop="weekDay" label="星期" width="80"></el-table-column>
                <el-table-column prop="studentNumber" label="学号" width="80"></el-table-column>
                <el-table-column prop="name" label="姓名" width="120"></el-table-column>
                <el-table-column label="操作" width="120">
                    <template slot-scope="scope">
                        <el-button 
                            size="mini" 
                            type="danger" 
                            @click="markUnfinishedStudentAsFinished(scope.row)">
                            标记完成
                        </el-button>
                    </template>
                </el-table-column>
                <el-table-column prop="content" label="作业内容" min-width="200" show-overflow-tooltip></el-table-column>
            </el-table>
        </el-dialog>
        
        <!-- 作业内容输入对话框 -->
        <el-dialog title="输入作业内容" :visible.sync="homeworkContentDialogVisible" width="50%">
            <el-input
                type="textarea"
                :rows="4"
                placeholder="请输入作业内容"
                v-model="tempHomeworkContent">
            </el-input>
            <span slot="footer" class="dialog-footer">
                <el-button @click="homeworkContentDialogVisible = false">取 消</el-button>
                <el-button type="primary" @click="saveHomeworkContentFromDialog">确 定</el-button>
            </span>
        </el-dialog>
    </div>

<!--    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>-->
<!--    <script src="https://unpkg.com/element-ui/lib/index.js"></script>-->
<!--    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>-->
    <script src="js/vue.js"></script>
    <script src="js/element-ui.js"></script>
    <script src="js/axios.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    loading: true,
                    currentTime: '',
                    currentDate: this.getCurrentDate(),
                    students: [],
                    homeworkTypes: [],
                    selectedType: 1,
                    homeworkContent: '',
                    tempHomeworkContent: '', // 用于弹窗中的临时作业内容
                    correctionRecords: [],
                    finishedCount: 0,
                    unfinishedCount: 0,
                    searchKeyword: '',
                    studentSuggestions: [],
                    studentHistoryDialogVisible: false,
                    studentHistoryRecords: [],
                    unfinishedStudentsDialogVisible: false,
                    unfinishedStudents: [],
                    homeworkContentDialogVisible: false // 作业内容弹窗可见性
                };
            },
            computed: {
                sortedStudents() {
                    // 创建学生列表的副本并按学号排序
                    return [...this.students].sort((a, b) => {
                        return a.studentNumber.localeCompare(b.studentNumber, undefined, {
                            numeric: true,
                            sensitivity: 'base'
                        });
                    });
                }
            },
            mounted() {
                this.updateTime();
                setInterval(this.updateTime, 1000);
                this.loadStudents();
                this.loadHomeworkTypes();
                this.loadData();
            },
            methods: {
                getCurrentDate() {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                },
                formatDate(dateString) {
                    const date = new Date(dateString);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                },
                updateTime() {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    const seconds = String(now.getSeconds()).padStart(2, '0');
                    this.currentTime = `${year}年${month}月${day}日 ${hours}:${minutes}:${seconds}`;
                },
                prevDay() {
                    const date = new Date(this.currentDate);
                    date.setDate(date.getDate() - 1);
                    this.currentDate = this.formatDate(date);
                    this.loadData();
                },
                nextDay() {
                    const date = new Date(this.currentDate);
                    date.setDate(date.getDate() + 1);
                    this.currentDate = this.formatDate(date);
                    this.loadData();
                },
                loadStudents() {
                    return axios.get('/api/students')
                        .then(response => {
                            this.students = response.data;
                        });
                },
                loadHomeworkTypes() {
                    return axios.get('/api/homework-types')
                        .then(response => {
                            this.homeworkTypes = response.data;
                        });
                },
                loadData() {
                    // 加载订正记录
                    axios.get(`/api/correction-records?date=${this.currentDate}&typeId=${this.selectedType}`)
                        .then(response => {
                            this.correctionRecords = response.data;
                            this.updateStats();
                        });

                    // 加载作业内容
                    axios.get(`/api/homework-contents?date=${this.currentDate}&typeId=${this.selectedType}`)
                        .then(response => {
                            // 检查响应状态码，204表示无内容
                            if (response.status === 204) {
                                this.homeworkContent = '';
                            } else {
                                this.homeworkContent = response.data ? response.data.content : '';
                            }
                        })
                        .catch(() => {
                            this.homeworkContent = '';
                        });
                },
                updateStats() {
                    axios.get(`/api/correction-records/statistics?date=${this.currentDate}&typeId=${this.selectedType}`)
                        .then(response => {
                            this.finishedCount = response.data.finished;
                            this.unfinishedCount = response.data.unfinished;
                            // 数据加载完成，隐藏loading
                            this.loading = false;
                        });
                },
                getStudentButtonClass(student) {
                    const record = this.correctionRecords.find(r => r.studentId === student.id);
                    if (record && record.corrected) {
                        return 'finished';
                    }
                    return 'unfinished';
                },
                toggleStudentStatus(student) {
                    let record = this.correctionRecords.find(r => r.studentId === student.id);

                    if (!record) {
                        // 创建新记录
                        record = {
                            date: this.currentDate,
                            studentId: student.id,
                            homeworkTypeId: this.selectedType,
                            corrected: true
                        };

                        axios.post('/api/correction-records', record)
                            .then(response => {
                                this.correctionRecords.push(response.data);
                                this.updateStats();
                            });
                    } else {
                        // 更新现有记录
                        record.corrected = !record.corrected;
                        axios.post('/api/correction-records', record)
                            .then(response => {
                                this.updateStats();
                            });
                    }
                },
                saveHomeworkContent() {
                    axios.get(`/api/homework-contents?date=${this.currentDate}&typeId=${this.selectedType}`)
                        .then(response => {
                            // 检查响应状态码，204表示无内容
                            let content;
                            if (response.status === 204) {
                                content = {};
                            } else {
                                content = response.data || {};
                            }

                            content.date = this.currentDate;
                            content.homeworkTypeId = this.selectedType;
                            content.content = this.homeworkContent;

                            return axios.post('/api/homework-contents', content);
                        })
                        .catch(() => {
                            // 新建
                            const content = {
                                date: this.currentDate,
                                homeworkTypeId: this.selectedType,
                                content: this.homeworkContent
                            };
                            return axios.post('/api/homework-contents', content);
                        });
                },
                resetStatus() {
                    this.$confirm('此操作将重置本页面订正状态, 是否继续?', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        axios.put(`/api/correction-records/reset?date=${this.currentDate}&typeId=${this.selectedType}`)
                            .then(() => {
                                this.loadData();
                                this.$message({
                                    type: 'success',
                                    message: '重置成功!'
                                });
                            });
                    });
                },
                querySearch(queryString, cb) {
                    // 当queryString为空时，显示所有学生（按学号排序）
                    if (!queryString) {
                        // 创建学生列表的副本并按学号排序
                        const sortedStudents = [...this.students].sort((a, b) => {
                            return a.studentNumber.localeCompare(b.studentNumber, undefined, {
                                numeric: true,
                                sensitivity: 'base'
                            });
                        });
                        cb(sortedStudents);
                        return;
                    }

                    // 当有查询字符串时，按原有逻辑过滤学生
                    axios.get(`/api/students/search?keyword=${queryString}`)
                        .then(response => {
                            cb(response.data);
                        });
                },
                handleSelectStudent(item) {
                    // 获取学生历史欠交记录
                    axios.get(`/api/correction-records/student-unfinished-all-types?studentId=${item.id}`)
                        .then(response => {
                            // 过滤掉未来日期的记录
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);

                            let studentHistoryRecords = response.data
                                .filter(record => {
                                    const recordDate = new Date(record.date);
                                    recordDate.setHours(0, 0, 0, 0);
                                    return recordDate <= today;
                                })
                                .map(record => {
                                    const type = this.homeworkTypes.find(t => t.id === record.homeworkTypeId);
                                    return {
                                        ...record,
                                        typeName: type ? type.name : ''
                                    };
                                });

                            // 为每个日期获取作业内容
                            const dates = [...new Set(studentHistoryRecords.map(r => r.date))];
                            const contentPromises = dates.map(date => {
                                // 确保日期格式为 yyyy-MM-dd
                                let formattedDate = date;
                                if (typeof date === 'string' && date.includes('T')) {
                                    // 如果是ISO格式日期，转换为 yyyy-MM-dd
                                    const d = new Date(date);
                                    formattedDate = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`;
                                }
                                // 为每条记录获取对应的作业类型内容
                                const record = studentHistoryRecords.find(r => r.date === date);
                                if (record) {
                                    return axios.get(`/api/homework-contents?date=${formattedDate}&typeId=${record.homeworkTypeId}`)
                                        .then(response => {
                                            // 检查响应状态码，204表示无内容
                                            if (response.status === 204) {
                                                return { data: null };
                                            } else {
                                                return response;
                                            }
                                        })
                                        .catch(() => ({ data: null })); // 处理没有作业内容的情况
                                }
                                return Promise.resolve({ data: null });
                            });

                            return Promise.all(contentPromises)
                                .then(results => {
                                    const contentMap = {};
                                    studentHistoryRecords.forEach((record, index) => {
                                        let recordDate = record.date;
                                        if (typeof recordDate === 'string' && recordDate.includes('T')) {
                                            const d = new Date(recordDate);
                                            recordDate = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`;
                                        }
                                        const key = `${recordDate}-${record.homeworkTypeId}`;
                                        // 检查results[index]是否存在再访问其data属性
                                        const result = results[index];
                                        const contentData = result && result.data;
                                        contentMap[key] = contentData ? contentData.content : '';
                                    });

                                    // 将作业内容添加到学生记录中
                                    this.studentHistoryRecords = studentHistoryRecords.map(record => {
                                        let recordDate = record.date;
                                        if (typeof recordDate === 'string' && recordDate.includes('T')) {
                                            const d = new Date(recordDate);
                                            recordDate = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`;
                                        }
                                        const key = `${recordDate}-${record.homeworkTypeId}`;
                                        return {
                                            ...record,
                                            content: contentMap[key] || ''
                                        };
                                    });

                                    if (this.studentHistoryRecords.length > 0) {
                                        // 默认按日期升序排序
                                        this.sortStudentHistory('date', 'asc');
                                        this.studentHistoryDialogVisible = true;
                                    } else {
                                        this.$message({
                                            type: 'info',
                                            message: '该学生在所有作业类型下都没有欠交记录'
                                        });
                                    }
                                });
                        })
                        .catch((e) => {
                            console.error('22222222');
                            console.error(e);
                            this.$message({
                                type: 'error',
                                message: '获取数据失败1'
                            });
                        });
                },
                showUnfinishedStudents() {
                    axios.get(`/api/correction-records/unfinished-students?typeId=${this.selectedType}`)
                        .then(response => {
                            // 先获取所有未完成学生的基本信息
                            const unfinishedStudents = response.data.map(item => {
                                // 格式化日期
                                let formattedDate = item.date;
                                if (typeof item.date === 'string' && item.date.includes('T')) {
                                    // 如果是ISO格式日期，转换为 yyyy-MM-dd
                                    const date = new Date(item.date);
                                    formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                                }

                                // 计算星期几
                                const dateObj = new Date(formattedDate);
                                const weekDays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
                                const weekDay = weekDays[dateObj.getDay()];

                                return {
                                    date: formattedDate,
                                    weekDay: weekDay,
                                    studentNumber: item.studentNumber,
                                    name: item.name,
                                    rawDate: formattedDate, // 保存格式化后的日期用于查询作业内容
                                    formattedDate: formattedDate // 保存格式化后的日期用于查询作业内容
                                };
                            });

                            // 为每个日期获取作业内容
                            const dates = [...new Set(unfinishedStudents.map(s => s.formattedDate))];
                            const contentPromises = dates.map(date =>
                                axios.get(`/api/homework-contents?date=${date}&typeId=${this.selectedType}`)
                                    .then(response => {
                                        // 检查响应状态码，204表示无内容
                                        if (response.status === 204) {
                                            return { data: null };
                                        } else {
                                            return response;
                                        }
                                    })
                                    .catch(() => ({ data: null })) // 处理没有作业内容的情况
                            );

                            return Promise.all(contentPromises)
                                .then(results => {
                                    const contentMap = {};
                                    dates.forEach((date, index) => {
                                        // 检查results[index]是否存在再访问其data属性
                                        const result = results[index];
                                        const contentData = result && result.data;
                                        contentMap[date] = contentData ? contentData.content : '';
                                    });

                                    // 将作业内容添加到学生记录中
                                    this.unfinishedStudents = unfinishedStudents.map(student => ({
                                        ...student,
                                        content: contentMap[student.formattedDate] || ''
                                    }));

                                    // 默认按日期升序排序
                                    this.sortUnfinishedStudents('date', 'asc');
                                    this.unfinishedStudentsDialogVisible = true;
                                });
                        })
                        .catch(error => {
                            console.error('获取未完成学生数据失败:', error);
                            this.$message({
                                type: 'error',
                                message: '获取数据失败2'
                            });
                        });
                },
                sortUnfinishedStudents(field, order) {
                    this.unfinishedStudents.sort((a, b) => {
                        let result = 0;

                        if (field === 'studentNumber') {
                            // 学号按数值大小排序
                            const numA = parseInt(a.studentNumber);
                            const numB = parseInt(b.studentNumber);
                            result = numA - numB;
                        } else if (field === 'date') {
                            // 日期排序
                            result = new Date(a.date) - new Date(b.date);
                            // 如果日期相同，按学号升序排列
                            if (result === 0) {
                                const numA = parseInt(a.studentNumber);
                                const numB = parseInt(b.studentNumber);
                                result = numA - numB;
                            }
                        }

                        // 如果是降序，反转结果
                        if (order === 'desc') {
                            result = -result;
                        }

                        return result;
                    });
                },
                markAsFinished(row) {
                    row.corrected = true;
                    axios.post('/api/correction-records', row)
                        .then(() => {
                            this.$message({
                                type: 'success',
                                message: '标记成功!'
                            });

                            // 从当前列表中移除该记录
                            const index = this.studentHistoryRecords.findIndex(item =>
                                item.id === row.id
                            );
                            if (index > -1) {
                                this.studentHistoryRecords.splice(index, 1);
                            }

                            // 如果所有记录都已标记完成，关闭弹窗
                            if (this.studentHistoryRecords.length === 0) {
                                this.studentHistoryDialogVisible = false;
                            }

                            // 刷新主页面数据
                            this.loadData();
                        });
                },
                sortStudentHistory(field, order) {
                    this.studentHistoryRecords.sort((a, b) => {
                        let result = 0;

                        if (field === 'date') {
                            // 日期排序
                            result = new Date(a.date) - new Date(b.date);
                            // 如果日期相同，按作业类型ID升序排列
                            if (result === 0) {
                                result = a.homeworkTypeId - b.homeworkTypeId;
                            }
                        } else if (field === 'typeName') {
                            // 作业类型ID排序
                            result = a.homeworkTypeId - b.homeworkTypeId;
                            // 如果作业类型ID相同，按日期升序排列
                            if (result === 0) {
                                result = new Date(a.date) - new Date(b.date);
                            }
                        }

                        // 如果是降序，反转结果
                        if (order === 'desc') {
                            result = -result;
                        }

                        return result;
                    });
                },
                markUnfinishedStudentAsFinished(row) {
                    // 标记历史欠交学生为已完成
                    // 首先需要找到该学生的订正记录ID
                    axios.get(`/api/correction-records?date=${row.rawDate}&typeId=${this.selectedType}`)
                        .then(response => {
                            // 在返回的记录中找到对应学生的记录
                            const student = this.students.find(s => s.studentNumber === row.studentNumber);
                            if (student) {
                                const record = response.data.find(r => r.studentId === student.id);
                                if (record) {
                                    // 更新记录状态为已完成
                                    record.corrected = true;
                                    return axios.post('/api/correction-records', record);
                                }
                            }
                            return Promise.reject("未找到对应记录");
                        })
                        .then(() => {
                            // 从当前列表中移除该记录
                            const index = this.unfinishedStudents.findIndex(item =>
                                item.date === row.date &&
                                item.studentNumber === row.studentNumber
                            );
                            if (index > -1) {
                                this.unfinishedStudents.splice(index, 1);
                            }

                            // 如果标记的是当前日期的记录，也需要更新主页面的数据
                            if (row.date === this.currentDate) {
                                this.loadData();
                            }

                            this.$message({
                                type: 'success',
                                message: '标记成功!'
                            });
                        })
                        .catch(error => {
                            this.$message({
                                type: 'error',
                                message: '标记失败: ' + error
                            });
                        });
                },
                showHomeworkContentDialog() {
                    // 将当前作业内容复制到临时变量
                    this.tempHomeworkContent = this.homeworkContent;
                    // 显示作业内容输入弹窗
                    this.homeworkContentDialogVisible = true;
                },

                saveHomeworkContentFromDialog() {
                    // 将临时变量的值保存到作业内容
                    this.homeworkContent = this.tempHomeworkContent;
                    // 隐藏弹窗
                    this.homeworkContentDialogVisible = false;
                    // 保存作业内容到服务器
                    this.saveHomeworkContent();
                }
            }
        });
    </script>
</body>
</html>