<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>五4班作业订正系统</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
            min-height: 100vh;
            // 禁用文字选中
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            // 禁用移动端的文本选择和高亮
            -webkit-tap-highlight-color: transparent;
        }
        /* 作业类型下拉框文字居中 */
        .center-select .el-input__inner {
            text-align: center;
        }
        .header {
            background: linear-gradient(90deg, #409EFF, #64b5f6);
            color: white;
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .header h1 {
            margin: 0;
            font-size: 28px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .poem {
            text-align: center;
            font-size: 18px;
            line-height: 1.5;
            font-weight: bold;
        }
        .current-time {
            font-size: 28px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .controls {
            margin-bottom: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .control-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        .control-group label {
            font-weight: bold;
            color: #333;
        }
        .main-content {
            display: flex;
            gap: 20px;
        }
        .stats {
            width: 130px;
            background: linear-gradient(135deg, #ffffff, #f0f4f8);
            padding: 20px 15px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .stat-item {
            text-align: center;
            margin-bottom: 25px;
            padding: 10px;
            border-radius: 12px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .stat-item:last-child {
            margin-bottom: 0;
        }
        .stat-number {
            font-size: 28px;
            font-weight: bold;
        }
        .finished {
            color: #67C23A;
        }
        .unfinished {
            color: #F56C6C;
        }
        .students-section {
            flex: 1;
        }
        .students-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .student-btn {
            height: 70px;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            width: 100%;
            box-sizing: border-box;
            padding: 8px;
            text-align: center;
            margin: 0;
            border-radius: 15px;
            border: 2px solid #e0e0e0;
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .student-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.15);
        }
        .el-button.unfinished {
            background: linear-gradient(135deg, #ff7b7b, #ff5252);
            border: 2px solid #ff6b6b;
            color: white;
            width: 100%;
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            padding: 8px;
            text-align: center;
            margin: 0;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(255, 82, 82, 0.3);
            transition: all 0.3s ease;
        }
        .el-button.unfinished:hover {
            background: linear-gradient(135deg, #ff6b6b, #ff4242);
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(255, 82, 82, 0.4);
        }
        .el-button.finished {
            background: linear-gradient(135deg, #67c23a, #4eab29);
            border: 2px solid #67c23a;
            color: white;
            width: 100%;
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            padding: 8px;
            text-align: center;
            margin: 0;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(103, 194, 58, 0.3);
            transition: all 0.3s ease;
        }
        .el-button.finished:hover {
            background: linear-gradient(135deg, #7cd94d, #5cb831);
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(103, 194, 58, 0.4);
        }
        .subject-toggle-btn {
            width: 100%;
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            padding: 8px;
            text-align: center;
            margin: 0;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            color: white;
        }
        
        .chinese-subject {
            background: linear-gradient(135deg, #FFA500, #FF8C00); /* 橙色 */
            border: 2px solid #FFA500;
        }
        
        .math-subject {
            background: linear-gradient(135deg, #409EFF, #64b5f6); /* 蓝色 */
            border: 2px solid #409EFF;
        }
        
        .english-subject {
            background: linear-gradient(135deg, #F56C6C, #ff4242); /* 红色 */
            border: 2px solid #F56C6C;
        }
        
        .subject-toggle-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        
        .spacer {
            width: 130px;
        }
        /* 弹窗样式优化 */
        .el-dialog {
            border-radius: 15px !important;
            overflow: hidden;
        }
        .el-dialog__header {
            background: linear-gradient(90deg, #409EFF, #64b5f6);
            color: white;
            padding: 20px;
        }
        .el-dialog__title {
            color: white;
            font-weight: bold;
        }
        .el-dialog__body {
            padding: 20px;
        }
        .el-dialog__footer {
            padding: 15px 20px;
            background-color: #f5f7fa;
        }
        /* 按钮样式优化 */
        .el-button {
            border-radius: 10px;
            font-weight: bold;
        }
        .el-button--primary {
            background: linear-gradient(90deg, #409EFF, #64b5f6);
            border: none;
        }
        .el-button--success {
            background: linear-gradient(90deg, #67C23A, #95d475);
            border: none;
        }
        .el-button--warning {
            background: linear-gradient(90deg, #E6A23C, #f3d19e);
            border: none;
        }
        .el-button--danger {
            background: linear-gradient(90deg, #F56C6C, #ff8e8e);
            border: none;
        }
        /* 表格样式优化 */
        .el-table {
            border-radius: 10px;
            overflow: hidden;
            // 允许在表格中选择文字
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        .el-table th {
            background-color: #ecf5ff;
        }
        /* 输入框样式优化 */
        .el-input__inner {
            border-radius: 10px;
            // 允许在输入框中选择文字
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        .el-select .el-input__inner {
            border-radius: 10px;
            // 允许在选择框中选择文字
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        .el-date-editor.el-input {
            border-radius: 10px;
            // 允许在日期编辑器中选择文字
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        // 允许在弹窗中的输入框选择文字
        .el-dialog .el-input__inner {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        .el-dialog .el-textarea__inner {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        /* 选择器样式优化 */
        .el-select-dropdown {
            border-radius: 10px;
            // 允许在下拉选项中选择文字
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        .el-date-picker {
            border-radius: 15px;
        }
        /* 加载指示器样式 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 24px;
            color: #409EFF;
        }
        .loading-content {
            text-align: center;
        }
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #409EFF;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 右键菜单样式 */
        .context-menu {
            position: fixed;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            min-width: 120px;
            padding: 4px 0;
            border: 1px solid #ebeef5;
        }
        
        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            transition: background-color 0.2s;
            user-select: none;
        }
        
        .context-menu-item:hover {
            background-color: #f5f7fa;
        }
        
        /* popover 菜单样式 */
        .popover-menu {
            position: absolute;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            min-width: 120px;
            padding: 4px 0;
            border: 1px solid #ebeef5;
            // 允许在popover菜单中选择文字
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        .popover-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            transition: background-color 0.2s;
            user-select: none;
        }
        
        .popover-menu-item:hover {
            background-color: #f5f7fa;
        }
        .el-autocomplete-suggestion {
            border-radius: 10px;
            // 允许在自动完成建议中选择文字
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
    </style>
</head>
<body>
    <div id="app" v-loading.fullscreen.lock="loading">
        <div class="header">
            <h1>五4班作业订正系统</h1>
            <div class="poem">
                百川东到海，何时复西归？<br>
                少壮不努力，老大徒伤悲。
            </div>
            <div class="current-time">{{ currentTime }}</div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <div style="display: flex; align-items: flex-start;">
                    <div style="margin-right: 10px;">
                        <div>
                            <el-date-picker
                                v-model="currentDate"
                                type="date"
                                placeholder="选择日期"
                                format="MM月dd日"
                                value-format="yyyy-MM-dd"
                                @change="loadData"
                                :clearable="false"
                                style="width: 120px; cursor: pointer;"
                                :editable="false">
                            </el-date-picker>
                        </div>
                        <div>
                            <el-select v-model="selectedType" @change="loadData" placeholder="请选择作业类型" style="width: 120px; margin-top: 5px;" class="center-select">
                                <el-option
                                    v-for="type in homeworkTypes"
                                    :key="type.id"
                                    :label="type.name"
                                    :value="type.id">
                                </el-option>
                            </el-select>
                        </div>
                    </div>
                    
                    <div style="margin-right: 10px;">
                        <div style="display: flex; margin-bottom: 5px;">
                            <el-button @click="prevDay" style="width: 70px; text-align: center; margin-right: 5px; display: flex; align-items: center; justify-content: center;">前一天</el-button>
                            <el-button @click="nextDay" style="width: 70px; text-align: center; display: flex; align-items: center; justify-content: center;">后一天</el-button>
                        </div>
                        <div style="display: flex;">
                            <el-button @click="prevAssignment" style="width: 70px; text-align: center; margin-right: 5px; display: flex; align-items: center; justify-content: center;">前一次</el-button>
                            <el-button @click="nextAssignment" style="width: 70px; text-align: center; display: flex; align-items: center; justify-content: center;">后一次</el-button>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: flex-start;">
                        <el-input
                            v-model="homeworkContent"
                            placeholder="请输入作业内容"
                            style="width: 300px; margin-right: 10px;"
                            @focus="showHomeworkContentDialog"
                            readonly>
                        </el-input>
                        
                        <el-button @click="resetStatus" type="warning" style="margin-right: 10px;">重置本页面订正状态</el-button>
                        <el-button @click="showUnfinishedStudents" style="margin-right: 10px;">本作业欠交名单</el-button>
                        
                        <span style="margin-right: 5px; font-weight: bold; display: flex; align-items: center; padding-top: 8px;">彻查学生作业：</span>
                        <el-autocomplete
                            v-model="searchKeyword"
                            :fetch-suggestions="querySearch"
                            placeholder="请输入学号或姓名"
                            @select="handleSelectStudent"
                            style="width: 150px;"
                            :trigger-on-focus="true">
                            <template slot-scope="{ item }">
                                <div class="name">{{ item.studentNumber }} - {{ item.name }}</div>
                            </template>
                        </el-autocomplete>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number finished">{{ finishedCount }}</div>
                    <div>已订正</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number unfinished">{{ unfinishedCount }}</div>
                    <div>未订正</div>
                </div>
                <div class="stat-item">
                    <el-button 
                        @click="switchSubject" 
                        class="subject-toggle-btn"
                        :class="subjectClass"
                        style="width: 100%; height: 70px; font-size: 18px; font-weight: bold; border-radius: 15px; color: white;">
                        {{ currentSubject }}
                    </el-button>
                </div>
            </div>
            
            <div class="students-section">
                <div class="students-grid">
                    <el-button
                        v-for="student in sortedStudents"
                        :key="student.id"
                        :class="getStudentButtonClass(student)"
                        @click="toggleStudentStatus(student)"
                        @mousedown.native="recordPressStart(student, $event)"
                        @mouseup.native="recordPressEnd($event)"
                        @contextmenu.native.prevent="showContextMenu($event, student)"
                        class="student-btn">
                        {{ student.studentNumber }}.{{ student.name }}
                    </el-button>
                </div>
            </div>
            
            <!-- 全局Popover用于长按和右键菜单 -->
            <el-popover
                placement="bottom"
                trigger="manual"
                v-model="contextMenuVisible"
                ref="globalPopover">
                <div style="padding: 5px; cursor: pointer;" @click.stop="checkStudentHistory()">彻查作业</div>
            </el-popover>
            
            <div class="spacer"></div>
        </div>
        
        <!-- 学生历史欠交记录对话框 -->
        <el-dialog :title="'学生历史欠交记录 - ' + selectedStudentName" :visible.sync="studentHistoryDialogVisible" width="60%">
            <div style="margin-bottom: 10px;">
                <el-button @click="sortStudentHistory('date', 'asc')">日期升序</el-button>
                <el-button @click="sortStudentHistory('date', 'desc')">日期降序</el-button>
                <el-button @click="sortStudentHistory('typeName', 'asc')">作业类型升序</el-button>
                <el-button @click="sortStudentHistory('typeName', 'desc')">作业类型降序</el-button>
            </div>
            <el-table :data="studentHistoryRecords" style="width: 100%">
                <el-table-column prop="date" label="日期" width="120">
                    <template slot-scope="scope">
                        {{ formatDate(scope.row.date) }}
                    </template>
                </el-table-column>
                <el-table-column prop="typeName" label="作业类型" width="120"></el-table-column>
                <el-table-column label="操作" width="120">
                    <template slot-scope="scope">
                        <el-button 
                            size="mini" 
                            :type="scope.row.corrected ? 'success' : 'danger'" 
                            @click="markAsFinished(scope.row)">
                            {{ scope.row.corrected ? '已完成' : '标记完成' }}
                        </el-button>
                    </template>
                </el-table-column>
                <el-table-column prop="content" label="内容" min-width="200" show-overflow-tooltip></el-table-column>
            </el-table>
        </el-dialog>
        
        <!-- 历史欠交学生对话框 -->
        <el-dialog title="历史欠交学生" :visible.sync="unfinishedStudentsDialogVisible" width="70%">
            <div style="margin-bottom: 10px;">
                <el-button @click="sortUnfinishedStudents('date', 'asc')">日期升序</el-button>
                <el-button @click="sortUnfinishedStudents('date', 'desc')">日期降序</el-button>
                <el-button @click="sortUnfinishedStudents('studentNumber', 'asc')">学号升序</el-button>
                <el-button @click="sortUnfinishedStudents('studentNumber', 'desc')">学号降序</el-button>
            </div>
            <el-table :data="unfinishedStudents" style="width: 100%" :max-height="400">
                <el-table-column prop="date" label="日期" width="120"></el-table-column>
                <el-table-column prop="weekDay" label="星期" width="80"></el-table-column>
                <el-table-column prop="studentNumber" label="学号" width="80"></el-table-column>
                <el-table-column prop="name" label="姓名" width="120"></el-table-column>
                <el-table-column label="操作" width="120">
                    <template slot-scope="scope">
                        <el-button 
                            size="mini" 
                            type="danger" 
                            @click="markUnfinishedStudentAsFinished(scope.row)">
                            标记完成
                        </el-button>
                    </template>
                </el-table-column>
                <el-table-column prop="content" label="作业内容" min-width="200" show-overflow-tooltip></el-table-column>
            </el-table>
        </el-dialog>
        
        <!-- 作业内容输入对话框 -->
        <el-dialog title="输入作业内容" :visible.sync="homeworkContentDialogVisible" width="350px" @opened="focusHomeworkContent">
            <el-input
                placeholder="请输入作业内容"
                v-model="tempHomeworkContent"
                ref="homeworkContentInput"
                style="width: 300px;"
                :maxlength="200">
            </el-input>
            <span slot="footer" class="dialog-footer">
                <el-button @click="homeworkContentDialogVisible = false">取 消</el-button>
                <el-button type="primary" @click="saveHomeworkContentFromDialog">确 定</el-button>
            </span>
        </el-dialog>
    </div>

<!--    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>-->
<!--    <script src="https://unpkg.com/element-ui/lib/index.js"></script>-->
<!--    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>-->
    <script src="js/vue.js"></script>
    <script src="js/element-ui.js"></script>
    <script src="js/axios.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    loading: true,
                    currentTime: '',
                    currentDate: this.getCurrentDate(),
                    students: [],
                    homeworkTypes: [],
                    selectedType: 1,
                    homeworkContent: '',
                    tempHomeworkContent: '', // 用于弹窗中的临时作业内容
                    correctionRecords: [],
                    finishedCount: 0,
                    unfinishedCount: 0,
                    searchKeyword: '',
                    studentSuggestions: [],
                    studentHistoryDialogVisible: false,
                    studentHistoryRecords: [],
                    unfinishedStudentsDialogVisible: false,
                    unfinishedStudents: [],
                    homeworkContentDialogVisible: false, // 作业内容弹窗可见性
                    selectedStudentName: '', // 当前选中学生的名字
                    subjects: ['语文', '数学', '英语'],
                    subjectIndex: 0,
                    // 长按相关状态
                    longPressTimer: null,
                    isLongPressTriggered: false, // 标志位，用于区分长按和短按
                    selectedStudent: null,
                    // popover相关
                    contextMenuVisible: false, // 控制全局popover的显示
                    mousePosition: { x: 0, y: 0 } // 鼠标位置
                };
            },
            computed: {
                sortedStudents() {
                    // 创建学生列表的副本并按学号排序
                    return [...this.students].sort((a, b) => {
                        return a.studentNumber.localeCompare(b.studentNumber, undefined, {
                            numeric: true,
                            sensitivity: 'base'
                        });
                    });
                },
                currentSubject() {
                    return this.subjects[this.subjectIndex];
                },
                subjectClass() {
                    // 根据当前科目返回相应的CSS类
                    switch(this.subjectIndex) {
                        case 0: // 语文 - 橙色
                            return 'chinese-subject';
                        case 1: // 数学 - 蓝色
                            return 'math-subject';
                        case 2: // 英语 - 红色
                            return 'english-subject';
                        default:
                            return 'math-subject';
                    }
                }
            },
            watch: {
                currentDate(newVal) {
                    sessionStorage.setItem('selectedDate', newVal);
                },
                selectedType(newVal) {
                    sessionStorage.setItem('selectedType', newVal);
                }
            },
            mounted() {
                // 绑定recordPressEndBound方法
                this.recordPressEndBound = this.recordPressEnd.bind(this);
                this.updateTime();
                setInterval(this.updateTime, 1000);
                this.loadStudents();
                this.loadHomeworkTypes();
                
                // 从sessionStorage恢复保存的日期和作业类型
                const savedDate = sessionStorage.getItem('selectedDate');
                const savedType = sessionStorage.getItem('selectedType');
                
                if (savedDate) {
                    this.currentDate = savedDate;
                }
                
                if (savedType) {
                    this.selectedType = parseInt(savedType);
                }
                
                this.loadData();
                
                // 添加全局mouseup事件监听器
                document.addEventListener('mouseup', this.recordPressEndBound);
                // 阻止整个文档的右键菜单，但允许学生按钮上的右键菜单
                document.addEventListener('contextmenu', (event) => {
                    // 检查右键点击是否发生在学生按钮上
                    if (event.target.classList.contains('student-btn') || event.target.closest('.student-btn')) {
                        // 如果是学生按钮，则不阻止默认行为，让Vue处理
                        return;
                    }
                    // 阻止其他地方的右键菜单
                    event.preventDefault();
                });
            },
            methods: {
                getCurrentDate() {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                },
                formatDate(dateString) {
                    const date = new Date(dateString);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                },
                updateTime() {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    const seconds = String(now.getSeconds()).padStart(2, '0');
                    this.currentTime = `${year}年${month}月${day}日 ${hours}:${minutes}:${seconds}`;
                },
                prevDay() {
                    const date = new Date(this.currentDate);
                    date.setDate(date.getDate() - 1);
                    this.currentDate = this.formatDate(date);
                    this.loadData();
                },
                nextDay() {
                    const date = new Date(this.currentDate);
                    date.setDate(date.getDate() + 1);
                    this.currentDate = this.formatDate(date);
                    this.loadData();
                },
                prevAssignment() {
                    // 获取前一次布置作业的日期
                    axios.get(`/api/correction-records/previous-assigned-date?typeId=${this.selectedType}&currentDate=${this.currentDate}`)
                        .then(response => {
                            if (response.data) {
                                this.currentDate = response.data;
                                this.loadData();
                            } else {
                                this.$message({
                                    type: 'info',
                                    message: '当前已是该类型作业最早的布置日期'
                                });
                            }
                        })
                        .catch(error => {
                            console.error('获取前一次布置日期失败:', error);
                            this.$message({
                                type: 'error',
                                message: '获取前一次布置日期失败'
                            });
                        });
                },
                nextAssignment() {
                    // 获取后一次布置作业的日期
                    axios.get(`/api/correction-records/next-assigned-date?typeId=${this.selectedType}&currentDate=${this.currentDate}`)
                        .then(response => {
                            if (response.data) {
                                this.currentDate = response.data;
                                this.loadData();
                            } else {
                                this.$message({
                                    type: 'info',
                                    message: '当前已是该类型作业最后的布置日期'
                                });
                            }
                        })
                        .catch(error => {
                            console.error('获取后一次布置日期失败:', error);
                            this.$message({
                                type: 'error',
                                message: '获取后一次布置日期失败'
                            });
                        });
                },
                loadStudents() {
                    return axios.get('/api/students')
                        .then(response => {
                            this.students = response.data;
                        });
                },
                loadHomeworkTypes() {
                    return axios.get('/api/homework-types')
                        .then(response => {
                            this.homeworkTypes = response.data;
                        });
                },
                loadData() {
                    // 加载订正记录
                    axios.get(`/api/correction-records?date=${this.currentDate}&typeId=${this.selectedType}`)
                        .then(response => {
                            this.correctionRecords = response.data;
                            this.updateStats();
                        });

                    // 加载作业内容
                    axios.get(`/api/homework-contents?date=${this.currentDate}&typeId=${this.selectedType}`)
                        .then(response => {
                            // 检查响应状态码，204表示无内容
                            if (response.status === 204) {
                                this.homeworkContent = '';
                            } else {
                                this.homeworkContent = response.data ? response.data.content : '';
                            }
                        })
                        .catch(() => {
                            this.homeworkContent = '';
                        });
                },
                updateStats() {
                    axios.get(`/api/correction-records/statistics?date=${this.currentDate}&typeId=${this.selectedType}`)
                        .then(response => {
                            this.finishedCount = response.data.finished;
                            this.unfinishedCount = response.data.unfinished;
                            // 数据加载完成，隐藏loading
                            this.loading = false;
                        });
                },
                getStudentButtonClass(student) {
                    const record = this.correctionRecords.find(r => r.studentId === student.id);
                    if (record && record.corrected) {
                        return 'finished';
                    }
                    return 'unfinished';
                },
                toggleStudentStatus(student) {
                    console.log('toggleStudentStatus 被调用');
                    // 如果触发了长按，则不执行点击操作
                    if (this.isLongPressTriggered) {
                        console.log('长按状态下不执行点击操作');
                        this.isLongPressTriggered = false; // 重置标志
                        return;
                    }
                    
                    console.log('执行点击操作');
                    // 正常的点击逻辑
                    let record = this.correctionRecords.find(r => r.studentId === student.id);

                    if (!record) {
                        // 创建新记录
                        record = {
                            date: this.currentDate,
                            studentId: student.id,
                            homeworkTypeId: this.selectedType,
                            corrected: true
                        };

                        axios.post('/api/correction-records', record)
                            .then(response => {
                                this.correctionRecords.push(response.data);
                                this.updateStats();
                            });
                    } else {
                        // 更新现有记录
                        record.corrected = !record.corrected;
                        axios.post('/api/correction-records', record)
                            .then(response => {
                                this.updateStats();
                            });
                    }
                },
                saveHomeworkContent() {
                    axios.get(`/api/homework-contents?date=${this.currentDate}&typeId=${this.selectedType}`)
                        .then(response => {
                            // 检查响应状态码，204表示无内容
                            let content;
                            if (response.status === 204) {
                                content = {};
                            } else {
                                content = response.data || {};
                            }

                            content.date = this.currentDate;
                            content.homeworkTypeId = this.selectedType;
                            content.content = this.homeworkContent;

                            return axios.post('/api/homework-contents', content);
                        })
                        .catch(() => {
                            // 新建
                            const content = {
                                date: this.currentDate,
                                homeworkTypeId: this.selectedType,
                                content: this.homeworkContent
                            };
                            return axios.post('/api/homework-contents', content);
                        });
                },
                resetStatus() {
                    this.$confirm('此操作将重置本页面订正状态, 是否继续?', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        axios.put(`/api/correction-records/reset?date=${this.currentDate}&typeId=${this.selectedType}`)
                            .then(() => {
                                this.loadData();
                                this.$message({
                                    type: 'success',
                                    message: '重置成功!'
                                });
                            });
                    });
                },
                querySearch(queryString, cb) {
                    // 当queryString为空时，显示所有学生（按学号排序）
                    if (!queryString) {
                        // 创建学生列表的副本并按学号排序
                        const sortedStudents = [...this.students].sort((a, b) => {
                            return a.studentNumber.localeCompare(b.studentNumber, undefined, {
                                numeric: true,
                                sensitivity: 'base'
                            });
                        });
                        cb(sortedStudents);
                        return;
                    }

                    // 当有查询字符串时，按原有逻辑过滤学生
                    axios.get(`/api/students/search?keyword=${queryString}`)
                        .then(response => {
                            cb(response.data);
                        });
                },
                handleSelectStudent(item) {
                    // 获取学生历史欠交记录
                    axios.get(`/api/correction-records/student-unfinished-all-types?studentId=${item.id}`)
                        .then(response => {
                            // 过滤掉未来日期的记录
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);

                            let studentHistoryRecords = response.data
                                .filter(record => {
                                    const recordDate = new Date(record.date);
                                    recordDate.setHours(0, 0, 0, 0);
                                    return recordDate <= today;
                                })
                                .map(record => {
                                    const type = this.homeworkTypes.find(t => t.id === record.homeworkTypeId);
                                    return {
                                        ...record,
                                        typeName: type ? type.name : ''
                                    };
                                });

                            // 为每个日期获取作业内容
                            const dates = [...new Set(studentHistoryRecords.map(r => r.date))];
                            const contentPromises = dates.map(date => {
                                // 确保日期格式为 yyyy-MM-dd
                                let formattedDate = date;
                                if (typeof date === 'string' && date.includes('T')) {
                                    // 如果是ISO格式日期，转换为 yyyy-MM-dd
                                    const d = new Date(date);
                                    formattedDate = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`;
                                }
                                // 为每条记录获取对应的作业类型内容
                                const record = studentHistoryRecords.find(r => r.date === date);
                                if (record) {
                                    return axios.get(`/api/homework-contents?date=${formattedDate}&typeId=${record.homeworkTypeId}`)
                                        .then(response => {
                                            // 检查响应状态码，204表示无内容
                                            if (response.status === 204) {
                                                return { data: null };
                                            } else {
                                                return response;
                                            }
                                        })
                                        .catch(() => ({ data: null })); // 处理没有作业内容的情况
                                }
                                return Promise.resolve({ data: null });
                            });

                            return Promise.all(contentPromises)
                                .then(results => {
                                    const contentMap = {};
                                    studentHistoryRecords.forEach((record, index) => {
                                        let recordDate = record.date;
                                        if (typeof recordDate === 'string' && recordDate.includes('T')) {
                                            const d = new Date(recordDate);
                                            recordDate = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`;
                                        }
                                        const key = `${recordDate}-${record.homeworkTypeId}`;
                                        // 检查results[index]是否存在再访问其data属性
                                        const result = results[index];
                                        const contentData = result && result.data;
                                        contentMap[key] = contentData ? contentData.content : '';
                                    });

                                    // 将作业内容添加到学生记录中
                                    this.studentHistoryRecords = studentHistoryRecords.map(record => {
                                        let recordDate = record.date;
                                        if (typeof recordDate === 'string' && recordDate.includes('T')) {
                                            const d = new Date(recordDate);
                                            recordDate = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`;
                                        }
                                        const key = `${recordDate}-${record.homeworkTypeId}`;
                                        return {
                                            ...record,
                                            content: contentMap[key] || ''
                                        };
                                    });

                                    if (this.studentHistoryRecords.length > 0) {
                                        // 设置选中学生的名字
                                        this.selectedStudentName = item.name;
                                        // 默认按日期升序排序
                                        this.sortStudentHistory('date', 'asc');
                                        this.studentHistoryDialogVisible = true;
                                    } else {
                                        this.$message({
                                            type: 'info',
                                            message: '该学生在所有作业类型下都没有欠交记录'
                                        });
                                    }
                                });
                        })
                        .catch((e) => {
                            console.error('22222222');
                            console.error(e);
                            this.$message({
                                type: 'error',
                                message: '获取数据失败1'
                            });
                        });
                },
                showUnfinishedStudents() {
                    axios.get(`/api/correction-records/unfinished-students?typeId=${this.selectedType}`)
                        .then(response => {
                            // 先获取所有未完成学生的基本信息
                            const unfinishedStudents = response.data.map(item => {
                                // 格式化日期
                                let formattedDate = item.date;
                                if (typeof item.date === 'string' && item.date.includes('T')) {
                                    // 如果是ISO格式日期，转换为 yyyy-MM-dd
                                    const date = new Date(item.date);
                                    formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                                }

                                // 计算星期几
                                const dateObj = new Date(formattedDate);
                                const weekDays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
                                const weekDay = weekDays[dateObj.getDay()];

                                return {
                                    date: formattedDate,
                                    weekDay: weekDay,
                                    studentNumber: item.studentNumber,
                                    name: item.name,
                                    rawDate: formattedDate, // 保存格式化后的日期用于查询作业内容
                                    formattedDate: formattedDate // 保存格式化后的日期用于查询作业内容
                                };
                            });

                            // 为每个日期获取作业内容
                            const dates = [...new Set(unfinishedStudents.map(s => s.formattedDate))];
                            const contentPromises = dates.map(date =>
                                axios.get(`/api/homework-contents?date=${date}&typeId=${this.selectedType}`)
                                    .then(response => {
                                        // 检查响应状态码，204表示无内容
                                        if (response.status === 204) {
                                            return { data: null };
                                        } else {
                                            return response;
                                        }
                                    })
                                    .catch(() => ({ data: null })) // 处理没有作业内容的情况
                            );

                            return Promise.all(contentPromises)
                                .then(results => {
                                    const contentMap = {};
                                    dates.forEach((date, index) => {
                                        // 检查results[index]是否存在再访问其data属性
                                        const result = results[index];
                                        const contentData = result && result.data;
                                        contentMap[date] = contentData ? contentData.content : '';
                                    });

                                    // 将作业内容添加到学生记录中
                                    this.unfinishedStudents = unfinishedStudents.map(student => ({
                                        ...student,
                                        content: contentMap[student.formattedDate] || ''
                                    }));

                                    // 默认按日期升序排序
                                    this.sortUnfinishedStudents('date', 'asc');
                                    this.unfinishedStudentsDialogVisible = true;
                                });
                        })
                        .catch(error => {
                            console.error('获取未完成学生数据失败:', error);
                            this.$message({
                                type: 'error',
                                message: '获取数据失败2'
                            });
                        });
                },
                sortUnfinishedStudents(field, order) {
                    this.unfinishedStudents.sort((a, b) => {
                        let result = 0;

                        if (field === 'studentNumber') {
                            // 学号按数值大小排序
                            const numA = parseInt(a.studentNumber);
                            const numB = parseInt(b.studentNumber);
                            result = numA - numB;
                        } else if (field === 'date') {
                            // 日期排序
                            result = new Date(a.date) - new Date(b.date);
                            // 如果日期相同，按学号升序排列
                            if (result === 0) {
                                const numA = parseInt(a.studentNumber);
                                const numB = parseInt(b.studentNumber);
                                result = numA - numB;
                            }
                        }

                        // 如果是降序，反转结果
                        if (order === 'desc') {
                            result = -result;
                        }

                        return result;
                    });
                },
                markAsFinished(row) {
                    row.corrected = true;
                    axios.post('/api/correction-records', row)
                        .then(() => {
                            this.$message({
                                type: 'success',
                                message: '标记成功!'
                            });

                            // 从当前列表中移除该记录
                            const index = this.studentHistoryRecords.findIndex(item =>
                                item.id === row.id
                            );
                            if (index > -1) {
                                this.studentHistoryRecords.splice(index, 1);
                            }

                            // 如果所有记录都已标记完成，关闭弹窗
                            if (this.studentHistoryRecords.length === 0) {
                                this.studentHistoryDialogVisible = false;
                            }

                            // 刷新主页面数据
                            this.loadData();
                        });
                },
                sortStudentHistory(field, order) {
                    this.studentHistoryRecords.sort((a, b) => {
                        let result = 0;

                        if (field === 'date') {
                            // 日期排序
                            result = new Date(a.date) - new Date(b.date);
                            // 如果日期相同，按作业类型ID升序排列
                            if (result === 0) {
                                result = a.homeworkTypeId - b.homeworkTypeId;
                            }
                        } else if (field === 'typeName') {
                            // 作业类型ID排序
                            result = a.homeworkTypeId - b.homeworkTypeId;
                            // 如果作业类型ID相同，按日期升序排列
                            if (result === 0) {
                                result = new Date(a.date) - new Date(b.date);
                            }
                        }

                        // 如果是降序，反转结果
                        if (order === 'desc') {
                            result = -result;
                        }

                        return result;
                    });
                },
                markUnfinishedStudentAsFinished(row) {
                    // 标记历史欠交学生为已完成
                    // 首先需要找到该学生的订正记录ID
                    axios.get(`/api/correction-records?date=${row.rawDate}&typeId=${this.selectedType}`)
                        .then(response => {
                            // 在返回的记录中找到对应学生的记录
                            const student = this.students.find(s => s.studentNumber === row.studentNumber);
                            if (student) {
                                const record = response.data.find(r => r.studentId === student.id);
                                if (record) {
                                    // 更新记录状态为已完成
                                    record.corrected = true;
                                    return axios.post('/api/correction-records', record);
                                }
                            }
                            return Promise.reject("未找到对应记录");
                        })
                        .then(() => {
                            // 从当前列表中移除该记录
                            const index = this.unfinishedStudents.findIndex(item =>
                                item.date === row.date &&
                                item.studentNumber === row.studentNumber
                            );
                            if (index > -1) {
                                this.unfinishedStudents.splice(index, 1);
                            }

                            // 如果标记的是当前日期的记录，也需要更新主页面的数据
                            if (row.date === this.currentDate) {
                                this.loadData();
                            }

                            this.$message({
                                type: 'success',
                                message: '标记成功!'
                            });
                        })
                        .catch(error => {
                            this.$message({
                                type: 'error',
                                message: '标记失败: ' + error
                            });
                        });
                },
                showHomeworkContentDialog() {
                    // 将当前作业内容复制到临时变量
                    this.tempHomeworkContent = this.homeworkContent;
                    // 显示作业内容输入弹窗
                    this.homeworkContentDialogVisible = true;
                },
                
                focusHomeworkContent() {
                    // 在弹窗打开后聚焦到文本输入框
                    this.$nextTick(() => {
                        if (this.$refs.homeworkContentInput) {
                            this.$refs.homeworkContentInput.focus();
                        }
                    });
                },

                saveHomeworkContentFromDialog() {
                    // 将临时变量的值保存到作业内容
                    this.homeworkContent = this.tempHomeworkContent;
                    // 隐藏弹窗
                    this.homeworkContentDialogVisible = false;
                    // 保存作业内容到服务器
                    this.saveHomeworkContent();
                },
                switchSubject() {
                    // 切换科目
                    this.subjectIndex = (this.subjectIndex + 1) % this.subjects.length;
                    // 弹出消息提示
                    this.$message({
                        message: '该功能老师还在开发中~',
                        type: 'info',
                        duration: 2000
                    });
                    // 可以在这里添加其他与科目切换相关的逻辑
                },
                
                // 记录按下开始时间并启动定时器
                recordPressStart(student, event) {
                    // 清除之前的定时器
                    this.cancelLongPress();
                    
                    this.selectedStudent = student;
                    // 重置长按标志
                    this.isLongPressTriggered = false;
                    
                    // 保存鼠标位置
                    this.mousePosition = {
                        x: event.clientX || (event.touches && event.touches[0].clientX),
                        y: event.clientY || (event.touches && event.touches[0].clientY)
                    };
                    
                    // 设置1秒后触发长按事件的定时器
                    this.longPressTimer = setTimeout(() => {
                        this.isLongPressTriggered = true; // 设置长按标志
                        
                        // 显示全局Popover
                        this.contextMenuVisible = true;
                        
                        // 设置popover位置为鼠标位置
                        this.$nextTick(() => {
                            const popover = this.$refs.globalPopover;
                            if (popover && popover.$el) {
                                const popper = popover.$el;
                                popper.style.position = 'fixed';
                                popper.style.left = this.mousePosition.x + 'px';
                                popper.style.top = this.mousePosition.y + 'px';
                                popper.style.transform = 'translate(0, 0)';
                            }
                        });
                        
                        // 添加全局点击监听器，用于隐藏popover
                        this.addGlobalClickListener();
                    }, 1000);
                },
                // 取消长按检测
                cancelLongPress() {
                    console.log('取消长按检测');
                    if (this.longPressTimer) {
                        clearTimeout(this.longPressTimer);
                        this.longPressTimer = null;
                    }
                },
                // 记录按下结束时间并判断是否为长按
                recordPressEnd(event) {
                    // 取消长按检测
                    this.cancelLongPress();
                    
                    // 移除document级别的mouseup事件监听器
                    document.removeEventListener('mouseup', this.recordPressEndBound);
                    
                    // 如果已经触发了长按（无论popover是否完全显示），则不需要做其他操作
                    if (this.isLongPressTriggered) {
                        return;
                    }
                },
                // 显示右键菜单
                showContextMenu(event, student) {
                    console.log('显示右键菜单被调用', { 
                        studentId: student.id, 
                        eventType: event.type
                    });
                    
                    event.preventDefault();  // 阻止浏览器默认右键菜单
                    event.stopPropagation(); // 阻止事件冒泡
                    
                    this.selectedStudent = student;
                    console.log('显示右键菜单，学生ID:', student.id);
                    
                    // 清除长按检测
                    this.cancelLongPress();
                    
                    // 保存鼠标位置
                    this.mousePosition = {
                        x: event.clientX,
                        y: event.clientY
                    };
                    
                    // 显示全局Popover
                    this.contextMenuVisible = true;
                    console.log('设置contextMenuVisible为true');
                    
                    // 设置popover位置为鼠标位置
                    this.$nextTick(() => {
                        const popover = this.$refs.globalPopover;
                        if (popover && popover.$el) {
                            const popper = popover.$el;
                            popper.style.position = 'fixed';
                            popper.style.left = this.mousePosition.x + 'px';
                            popper.style.top = this.mousePosition.y + 'px';
                            popper.style.transform = 'translate(0, 0)';
                        }
                    });
                    
                    // 添加全局点击监听器，用于隐藏popover
                    this.addGlobalClickListener();
                },
                // 添加全局点击监听器
                addGlobalClickListener() {
                    // 创建一个函数用于隐藏popover
                    const hidePopover = (event) => {
                        // 检查mousedown事件是否发生在popover内部
                        const popoverElements = document.querySelectorAll('.el-popover');
                        let isClickInsidePopover = false;
                        for (let i = 0; i < popoverElements.length; i++) {
                            if (popoverElements[i] === event.target || popoverElements[i].contains(event.target)) {
                                isClickInsidePopover = true;
                                break;
                            }
                        }
                        
                        // 检查是否是学生按钮
                        const isClickOnStudentButton = event.target.classList.contains('student-btn') || 
                                                     event.target.closest('.student-btn');
                        
                        // 只有当mousedown事件发生在popover外部且不是学生按钮时，才隐藏popover
                        if (!isClickInsidePopover && !isClickOnStudentButton) {
                            this.contextMenuVisible = false;
                            // 移除事件监听器
                            document.removeEventListener('mousedown', hidePopover);
                        }
                    };
                    
                    // 在下一个tick添加事件监听器，避免立即触发
                    this.$nextTick(() => {
                        // 先移除之前的监听器（如果有的话）
                        document.removeEventListener('mousedown', this.globalClickListener);
                        // 保存当前监听器的引用
                        this.globalClickListener = hidePopover;
                        // 使用mousedown事件而不是click事件
                        document.addEventListener('mousedown', hidePopover);
                    });
                },
                
                // 彻查学生作业历史
                checkStudentHistory() {
                    this.contextMenuVisible = false;
                    // 移除全局点击监听器
                    if (this.globalClickListener) {
                        document.removeEventListener('mousedown', this.globalClickListener);
                    }
                    if (this.selectedStudent) {
                        this.handleSelectStudent(this.selectedStudent);
                    }
                }
            }
        });
    </script>
</body>
</html>